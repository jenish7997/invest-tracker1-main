rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      // The admin claim is on the authentication TOKEN, not in the database.
      // This is the correct way to check for the admin role.
      return request.auth.token.admin == true;
    }

    // INVESTORS Collection
    match /investors/{investorId} {
      // Admins can read the full list of investors (for the report page)
      allow list: if isAdmin();
      // An admin can get any investor's data
      // A user can ONLY get their own data (by matching their UID to the document ID)
      allow get: if isAdmin() || request.auth.uid == investorId;
      // Only admins can create, update, or delete investors
      allow write: if isAdmin();
    }

    // TRANSACTIONS Collection
    match /transactions/{transactionId} {
      // Admins can list all transactions
      // Users can ONLY list transactions where their UID matches the 'uid' field
      allow list: if isAdmin() || request.auth.uid == request.query.uid;
      // An admin can get any transaction
      // A user can ONLY get their own transactions
      allow get: if isAdmin() || request.auth.uid == resource.data.uid;
      // Only admins can create transactions
      allow write: if isAdmin();
    }

    // RATES Collection (Admins only)
    match /rates/{rateId} {
      allow read, write: if isAdmin();
    }
  }
}
